@using Tekus.Frontend.Models
@using Tekus.Frontend.Services
@inject ProviderApiService Api
@inject IDialogService DialogService
<MudDialog>

    <DialogContent>
        <MudText Typo="Typo.h6">Servicios del proveedor</MudText>

        <MudTable T="ServiceDto"
                  @ref="_table"
                  ServerData="LoadServerData"
                  RowsPerPage="_pageSize">

            <HeaderContent>
                <MudTh>Nombre</MudTh>
                <MudTh>Valor hora (USD)</MudTh>
                <MudTh>País(es)</MudTh>
                <MudTh>Acciones</MudTh>
            </HeaderContent>

            <RowTemplate>
                <MudTd>@context.Name</MudTd>
                <MudTd>@context.HourValueUsd</MudTd>
                <MudTd>
                    @string.Join(", ", context.Countries.Select(c => c.Name))
                </MudTd>

                <MudTd>
                    <MudStack Spacing="1" direction="Row">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                       Color="Color.Primary"
                                       OnClick="@(() => OpenEditServiceDialog(context))" />

                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                       Color="Color.Error"
                                       OnClick="@(() => ConfirmDeleteService(context))" />
                    </MudStack>
                </MudTd>
            </RowTemplate>

        </MudTable>
    </DialogContent>

    <DialogActions>
        <MudButton Color="Color.Secondary" OnClick="Cancel">
            Cerrar
        </MudButton>
    </DialogActions>
</MudDialog>


@code {
    [CascadingParameter]
    public IMudDialogInstance MudDialog { get; set; } = default!;


    [Parameter]
    public Guid ProviderId { get; set; }
    [Parameter]
    public Guid ServiceId { get; set; }
    private MudTable<ServiceDto> _table;

    private int _pageSize = 10;
    private UpdateServiceRequest _model = new();
    private HashSet<string> SelectedCountryCodes = new();
    private async Task<TableData<ServiceDto>> LoadServerData(
        TableState state,
        CancellationToken token)
    {
        var page = state.Page + 1;
        var result = await Api.GetServicesByProviderAsync(
            ProviderId, page, state.PageSize);

        return new TableData<ServiceDto>
        {
            Items = result.Items,
            TotalItems = result.TotalCount
        };
    }
    private async Task OpenEditServiceDialog(ServiceDto service)
    {
        var parameters = new DialogParameters
        {
            ["ProviderId"] = ProviderId,
            ["Service"] = service
        };

        var dialog = await DialogService.ShowAsync<EditServiceDialog>(
            "Editar servicio",
            parameters
        );

        var result = await dialog.Result;

        if (!result.Canceled)
        {
            // refresca la tabla sin recargar la página
            await _table.ReloadServerData();
        }
    }
    private async Task ConfirmDeleteService(ServiceDto service)
    {
        bool? confirmed = await DialogService.ShowMessageBox(
            "Eliminar servicio",
            $"¿Eliminar el servicio {service.Name}?",
            yesText: "Eliminar",
            cancelText: "Cancelar"
        );

        if (confirmed == true)
        {
            await Api.DeleteServiceAsync(ProviderId, service.Id);
            await _table!.ReloadServerData();
        }
    }

    private void Cancel()
    {
        Console.WriteLine($"Dialog instance: {MudDialog}");
        MudDialog?.Cancel();
    }
}