@using Tekus.Frontend.Models
@using Tekus.Frontend.Services
@inject ProviderApiService Api
@inject IDialogService DialogService
@inject ISnackbar Snackbar
<MudDialog>

    <DialogContent>
        <MudText Typo="Typo.h6">Servicios del proveedor @ProviderName</MudText>

        <MudTextField @bind-Value="_search"
                      Placeholder="Buscar servicio"
                      Variant="Variant.Outlined"
                      Immediate="true"
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Search"
                      OnKeyDown="OnSearchKeyDown"
                      Class="mb-3" />

        <MudTable T="ServiceDto"
                  @ref="_table"
                  ServerData="LoadServerData"
                  RowsPerPage="10"
                  Dense="true"
                  Hover="true">

            <HeaderContent>
                <MudTh>
                    <MudTableSortLabel T="ServiceDto" SortLabel="name">
                        Nombre
                    </MudTableSortLabel>
                </MudTh>

                <MudTh>
                    <MudTableSortLabel T="ServiceDto" SortLabel="hourvalueUsd">
                        Valor Hora (USD)
                    </MudTableSortLabel>
                </MudTh>

                <MudTh>Países</MudTh>
                <MudTh>Acciones</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>@context.Name</MudTd>
                <MudTd>@context.HourValueUsd</MudTd>

                <MudTd>
                    @if (context.Countries.Any())
                    {
                        @string.Join(", ", context.Countries.Select(c => c.Name))
                    }
                    else
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary">—</MudText>
                    }
                </MudTd>

                <MudTd>
                    <MudStack Spacing="1" direction="Row">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                       Color="Color.Primary"
                                       OnClick="@(() => OpenEditServiceDialog(context))" />

                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                       Color="Color.Error"
                                       OnClick="@(() => ConfirmDeleteService(context))" />
                    </MudStack>
                </MudTd>
            </RowTemplate>

            <PagerContent>
                <MudTablePager PageSizeOptions="new int[] { 5, 10, 20 }" />
            </PagerContent>

        </MudTable>
    </DialogContent>

    <DialogActions>
        <MudButton Color="Color.Secondary" OnClick="Cancel">
            Cerrar
        </MudButton>
    </DialogActions>
</MudDialog>


@code {
    [CascadingParameter]
    public IMudDialogInstance MudDialog { get; set; } = default!;
    [Parameter]
    public string ProviderName { get; set; } = string.Empty;
    [Parameter]
    public Guid ProviderId { get; set; }
    [Parameter]
    public Guid ServiceId { get; set; }
    private MudTable<ServiceDto> _table;
    private string _search = string.Empty;  
   /* private UpdateServiceRequest _model = new();
     private HashSet<string> SelectedCountryCodes = new();*/
    private async Task<TableData<ServiceDto>> LoadServerData(
     TableState state,
     CancellationToken token)
    {
        var page = state.Page + 1;
        var pageSize = state.PageSize;

        var orderBy = state.SortLabel;
        var orderAsc = state.SortDirection != SortDirection.Descending;

        var result = await Api.GetServicesByProviderAsync(
            ProviderId,
            page,
            pageSize,
            _search,
            orderBy,
            orderAsc
        );

        return new TableData<ServiceDto>
        {
            Items = result.Items,
            TotalItems = result.TotalItems
        };
    }
    private async Task OnSearchKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && _table is not null)
            await _table.ReloadServerData();
    }
    private async Task OpenEditServiceDialog(ServiceDto service)
    {
        var parameters = new DialogParameters
        {
            ["ProviderId"] = ProviderId,
            ["Service"] = service
        };

        var dialog = await DialogService.ShowAsync<EditServiceDialog>(
            "Editar servicio",
            parameters
        );

        var result = await dialog.Result;

        if (!result.Canceled)
        {
            // refresca la tabla sin recargar la página
            await _table.ReloadServerData();
        }
    }
    private async Task ConfirmDeleteService(ServiceDto service)
    {
        bool? confirmed = await DialogService.ShowMessageBox(
            "Eliminar servicio",
            $"¿Eliminar el servicio {service.Name}?",
            yesText: "Eliminar",
            cancelText: "Cancelar"
        );

        if (confirmed == true)
        {
            try
            {
                await Api.DeleteServiceAsync(ProviderId, service.Id);

                Snackbar.Add("Servicio eliminado correctamente", Severity.Success);

                await _table!.ReloadServerData();
            }
            catch (Exception ex)
            {
                Snackbar.Add("Error al eliminar el servicio", Severity.Error);
                Console.Error.WriteLine(ex);
            }
        }
    }

    private void Cancel()
    {
        Console.WriteLine($"Dialog instance: {MudDialog}");
        MudDialog?.Cancel();
    }
}