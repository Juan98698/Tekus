@using Tekus.Frontend.Models
@using Tekus.Frontend.Services
@page "/providers"
@inject ProviderApiService Api
@inject IDialogService DialogService
@inject ISnackbar Snackbar
<MudText Typo="Typo.h4">Providers</MudText>

<MudButton Color="Color.Primary" OnClick="OpenCreateDialog">
    Create Provider
</MudButton>

<MudTextField @bind-Value="_search"
              Placeholder="Buscar por nombre o NIT"
              Variant="Variant.Outlined"
              Immediate="true"
              DebounceInterval="400"
              Adornment="Adornment.Start"
              AdornmentIcon="@Icons.Material.Filled.Search"
              Class="mb-4"             
              OnKeyDown="OnSearchKeyDown" />

              
             

<MudTable T="ProviderDto"
          @ref="_table"
          ServerData="LoadServerData"
          RowsPerPage="10"        
          Hover="true"
          Dense="true">
       

   <HeaderContent>
    <MudTh>
        <MudTableSortLabel T="ProviderDto" SortLabel="name">
            Nombre
        </MudTableSortLabel>
    </MudTh>

    <MudTh>
        <MudTableSortLabel T="ProviderDto" SortLabel="nit">
            NIT
        </MudTableSortLabel>
    </MudTh>

    <MudTh>
        <MudTableSortLabel T="ProviderDto" SortLabel="email">
            Email
        </MudTableSortLabel>
    </MudTh>

    <MudTh>
        Campos Personalizados
    </MudTh>

    <MudTh>
        Acciones
    </MudTh>
</HeaderContent>

    <RowTemplate>
        <MudTd>@context.Name</MudTd>
        <MudTd>@context.Nit</MudTd>
        <MudTd>@context.Email</MudTd>

        <MudTd>
            @if (context.CustomFields != null && context.CustomFields.Any())
            {
                <MudStack Spacing="0">
                    @foreach (var field in context.CustomFields)
                    {
                        <MudText Typo="Typo.caption">
                            <b>@field.Key:</b> @field.Value
                        </MudText>
                    }
                </MudStack>
            }
            else
            {
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    —
                </MudText>
            }
        </MudTd>

        <MudTd>
            <MudStack Spacing="1">
                <MudButton Size="Size.Small"
                           Variant="Variant.Outlined"
                           OnClick="@(() => OpenServicesDialog(context))">
                    Ver servicios
                </MudButton>

                <MudButton Size="Size.Small"
                           Color="Color.Primary"
                           OnClick="@(() => OpenCreateServiceDialog(context.Id))">
                    Crear servicio
                </MudButton>

                <MudButton Size="Size.Small"
                           Color="Color.Warning"
                           OnClick="@(() => OpenEditProviderDialog(context))">
                    Editar Proveedor
                </MudButton>

                <MudButton Size="Size.Small"
                           Color="Color.Error"
                           OnClick="@(() => ConfirmDeleteProvider(context))">
                    Eliminar Proveedor
                </MudButton>
            </MudStack>
        </MudTd>
    </RowTemplate>

    <PagerContent>
        <MudTablePager PageSizeOptions="new int[] { 5, 10, 20 }" />
    </PagerContent>

</MudTable>

@code {

    protected override Task OnInitializedAsync()
    {
        return Task.CompletedTask;
    }
    private MudTable<ProviderDto> _table;
 
    private async Task<TableData<ProviderDto>> LoadServerData(
    TableState state,
    CancellationToken cancellationToken)
    {
        var page = state.Page + 1;
        var pageSize = state.PageSize;

        string orderBy = state.SortLabel;
        bool orderAsc = state.SortDirection != SortDirection.Descending;

        var result = await Api.GetProvidersAsync(
            page,
            pageSize,
            _search,
            orderBy,
            orderAsc
        );

        return new TableData<ProviderDto>
        {
            TotalItems = result.TotalItems,
            Items = result.Items
        };
    }
    

    private async Task OnSearchKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && _table is not null)
        {
               
            await _table.ReloadServerData();
        }
    }

    private string _search = string.Empty;
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
            await _table!.ReloadServerData();
    }

    private async Task OnSearchChanged(string value)
    {
        _search = value;
        await _table!.ReloadServerData();
    }
    private async Task ReloadTable(string _)
    {
        if (_table is not null)
        {
            
            await _table.ReloadServerData();
        }
    }
  

    private async Task OpenServicesDialog(ProviderDto provider)
    {
        var parameters = new DialogParameters
        {
            ["ProviderId"] = provider.Id,
            ["ProviderName"] = provider.Name
            
        };

        var options = new DialogOptions
        {
            CloseButton = false,
            BackdropClick = false,
            MaxWidth = MaxWidth.Large,
            FullWidth = true
        };

        await DialogService.ShowAsync<ProviderServicesDialog>(
            "Servicios",
            parameters,
            options
        );
    }

    private async Task OpenCreateServiceDialog(Guid providerId)
    {
        var parameters = new DialogParameters
        {
            ["ProviderId"] = providerId
        };

        var options = new DialogOptions
        {
            CloseButton = false,
            BackdropClick = false,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<AddServiceDialog>(
            "Crear servicio",
            parameters,
            options
        );

        var result = await dialog.Result;

        if (!result.Canceled)
            await _table!.ReloadServerData();
    }

    private async Task OpenCreateDialog()
    {
        var options = new DialogOptions
        {
            CloseButton = false,
            BackdropClick = false,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<CreateProviderDialog>(
            "Crear Proveedor",
            options: options
        );

        var result = await dialog.Result;

        if (!result.Canceled)
           await _table!.ReloadServerData();
    }

    private async Task OpenEditProviderDialog(ProviderDto provider)
    {
        var parameters = new DialogParameters
        {
            ["Provider"] = provider
        };

        var options = new DialogOptions
        {
            CloseButton = false,
            BackdropClick = false,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<EditProviderDialog>(
            "Editar proveedor",
            parameters,
            options
        );

        var result = await dialog.Result;

        if (!result.Canceled)
           await _table!.ReloadServerData();
    }

    private async Task ConfirmDeleteProvider(ProviderDto provider)
    {
        bool? confirmed = await DialogService.ShowMessageBox(
            "Eliminar proveedor",
            $"¿Estás seguro de eliminar a {provider.Name}?",
            yesText: "Eliminar",
            cancelText: "Cancelar"
        );

        if (confirmed == true)
        {
            try
            {
                await Api.DeleteProviderAsync(provider.Id);

                Snackbar.Add(
                    "Proveedor eliminado correctamente",
                    Severity.Success
                );

                await _table!.ReloadServerData();
            }
            catch (HttpRequestException ex)
            {
                Snackbar.Add(ex.Message, Severity.Error);
            }
        }
    }
}