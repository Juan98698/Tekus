@using Tekus.Frontend.Models
@using Tekus.Frontend.Services
@page "/providers"
@inject ProviderApiService Api
@inject IDialogService DialogService

<MudText Typo="Typo.h4">Providers</MudText>

<MudButton Color="Color.Primary" OnClick="OpenCreateDialog">
    Create Provider
</MudButton>

<MudTable T="ProviderDto"
          Items="_providers"
          RowsPerPage="_pageSize"
          Page="@(_page - 1)"
          PageChanged="OnPageChanged">

    <HeaderContent>
        <MudTh>Nombre</MudTh>
        <MudTh>NIT</MudTh>
        <MudTh>Email</MudTh>
        <MudTh>Acciones</MudTh>
    </HeaderContent>

    <RowTemplate>
        <MudTd>@context.Name</MudTd>
        <MudTd>@context.Nit</MudTd>
        <MudTd>@context.Email</MudTd>

        <MudTd>
            <MudStack Spacing="1">
                <MudButton Size="Size.Small"
                           Variant="Variant.Outlined"
                           OnClick="@(() => OpenServicesDialog(context.Id))">
                    Ver servicios
                </MudButton>

                <MudButton Size="Size.Small"
                           Color="Color.Primary"
                           OnClick="@(() => OpenCreateServiceDialog(context.Id))">
                    Crear servicio
                </MudButton>
            </MudStack>
        </MudTd>
    </RowTemplate>

</MudTable>

@code {
    private List<ProviderDto> _providers = [];
    private int _page = 1;
    private int _pageSize = 10;

    protected override async Task OnInitializedAsync()
    {
        await LoadProviders();
    }

    private async Task LoadProviders()
    {
        var result = await Api.GetProvidersAsync(_page, _pageSize);
        _providers = result.Items;
    }

    private async Task OnPageChanged(int page)
    {
        _page = page + 1;
        await LoadProviders();
    }

    private async Task OpenServicesDialog(Guid providerId)
    {
        var parameters = new DialogParameters
        {
            ["ProviderId"] = providerId
        };

        var options = new DialogOptions
        {
            CloseButton = false,
            BackdropClick = false,
            MaxWidth = MaxWidth.Large,
            FullWidth = true
        };

        await DialogService.ShowAsync<ProviderServicesDialog>(
            "Servicios",
            parameters,
            options
        );
    }

    private async Task OpenCreateServiceDialog(Guid providerId)
    {
        var parameters = new DialogParameters
        {
            ["ProviderId"] = providerId
        };

        var options = new DialogOptions
        {
            CloseButton = false,
            BackdropClick = false,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<AddServiceDialog>(
            "Crear servicio",
            parameters,
            options
        );

        var result = await dialog.Result;

        if (!result.Canceled)
            await LoadProviders();
    }

    private async Task OpenCreateDialog()
    {
        var options = new DialogOptions
        {
            CloseButton = false,
            BackdropClick = false,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<CreateProviderDialog>(
            "Create Provider",
            options: options
        );

        var result = await dialog.Result;

        if (!result.Canceled)
            await LoadProviders();
    }
}