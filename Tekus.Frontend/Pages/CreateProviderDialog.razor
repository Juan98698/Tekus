
@using Tekus.Frontend.Models
@using Tekus.Frontend.Services
@inject ProviderApiService Api

<MudDialog>
    <DialogContent>
        <MudTextField Label="NIT" @bind-Value="_model.Nit" />
        <MudTextField Label="Name" @bind-Value="_model.Name" />
        <MudTextField Label="Email" @bind-Value="_model.Email" />
        <MudDivider Class="my-3" />

        <MudText Typo="Typo.subtitle1">Campos personalizados</MudText>

        @foreach (var field in _customFields)
        {
            <MudGrid Class="mb-2">
                <MudItem xs="5">
                    <MudTextField Label="Nombre" @bind-Value="field.Key" />
                </MudItem>
                <MudItem xs="5">
                    <MudTextField Label="Valor" @bind-Value="field.Value" />
                </MudItem>
                <MudItem xs="2" Class="d-flex align-center">
                    <MudIconButton Icon="@Icons.Material.Filled.Close"
                                   Color="Color.Error"
                                   OnClick="@(() => RemoveField(field))" />
                </MudItem>
            </MudGrid>
        }

        <MudButton Variant="Variant.Outlined"
                   StartIcon="@Icons.Material.Filled.Add"
                   OnClick="AddField">
            Agregar campo
        </MudButton>

    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Primary" OnClick="Submit">
            Guardar
        </MudButton>

        <MudButton Color="Color.Secondary" OnClick="Cancel">
            Cancelar
        </MudButton>
    </DialogActions>
</MudDialog>


@code {
    [CascadingParameter]
    public IMudDialogInstance MudDialog { get; set; } = default!;

    private CreateProviderRequest _model = new();
    private List<CustomFieldDto> _customFields = new();

    private void AddField()
    {
        _customFields.Add(new CustomFieldDto());
    }

    private void RemoveField(CustomFieldDto field)
    {
        _customFields.Remove(field);
    }


    private async Task Submit()
    {
        foreach (var field in _customFields)
        {
            if (!string.IsNullOrWhiteSpace(field.Key))
                _model.CustomFields[field.Key] = field.Value;
        }

        await Api.CreateProviderAsync(_model);
        MudDialog.Close(DialogResult.Ok(true));
    }

    private void Cancel()
    {
        Console.WriteLine($"Dialog instance: {MudDialog}");
        MudDialog?.Cancel();
    }
}

