
@inject CountryApiService CountryApi
@inject ProviderApiService ProviderApi
@inject ISnackbar Snackbar
@using Tekus.Frontend.Models
@using Tekus.Frontend.Services

<MudDialog>

    <DialogContent>
        <MudText Typo="Typo.h6">Nuevo servicio</MudText>

        <MudForm @ref="_form" Model="_model">

            <MudTextField Label="Nombre del servicio"
                          @bind-Value="_model.Name"
                          Required="true"
                          RequiredError="El nombre es obligatorio" />

            <MudNumericField T="decimal"
                             Label="Valor hora (USD)"
                             @bind-Value="_model.HourValueUsd"
                             Min="0.01m"
                             Required="true"
                             RequiredError="El valor debe ser mayor a 0" />

            <MudSelect T="string"
                       Label="Países"
                       MultiSelection
                       SelectedValues="_model.CountryCodes"
                       SelectedValuesChanged="v => _model.CountryCodes = v.ToHashSet()">

                @foreach (var country in _availableCountries)
                {
                    <MudSelectItem Value="@country.Code">
                        @country.Name
                    </MudSelectItem>
                }
            </MudSelect>

        </MudForm>
    </DialogContent>

    <DialogActions>
        <MudButton Color="Color.Primary" OnClick="Submit">
            Guardar
        </MudButton>

        <MudButton Color="Color.Secondary" OnClick="Cancel">
            Cerrar
        </MudButton>
    </DialogActions>

</MudDialog>
@code {
    [CascadingParameter]
    public IMudDialogInstance MudDialog { get; set; } = default!;
    private void Cancel()
    {
        Console.WriteLine($"Dialog instance: {MudDialog}");
        MudDialog?.Cancel();
    }
    [Parameter]
    public Guid ProviderId { get; set; }
    private MudForm _form;
    private AddServiceRequest _model = new();
    private List<CountryDto> _availableCountries = new();

    protected override async Task OnInitializedAsync()
    {
        _availableCountries = await CountryApi.GetCountriesAsync();
    }
    private async Task Submit()
    {
        await _form!.Validate();

        if (!_form.IsValid)
            return;

        try
        {
            var service = await ProviderApi.AddServiceAsync(
                ProviderId,
                new AddServiceRequest
                {
                    Name = _model.Name,
                    HourValueUsd = _model.HourValueUsd
                });

            if (_model.CountryCodes.Any())
            {
                await ProviderApi.AssignCountriesAsync(
                    ProviderId,
                    service.Id,
                    _model.CountryCodes.ToList());
            }

            Snackbar.Add("Servicio creado correctamente", Severity.Success);

            MudDialog.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Snackbar.Add("Error al guardar el servicio", Severity.Error);

            Console.Error.WriteLine(ex);
        }
    }


}