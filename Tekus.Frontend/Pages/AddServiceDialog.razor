@using MudBlazor
@inject CountryApiService CountryApi
@inject ProviderApiService ProviderApi

@using Tekus.Frontend.Models
@using Tekus.Frontend.Services

<MudDialog>
    <DialogContent>

        <MudText Typo="Typo.h6">Nuevo servicio</MudText>

   
        <MudTextField Label="Nombre del servicio"
                      @bind-Value="_model.Name"
                      Required="true" />

  
        <MudNumericField T="decimal"
                         Label="Valor hora (USD)"
                         @bind-Value="_model.HourValueUsd"
                         Required="true"
                         Min="0" />

   
        @if (_availableCountries.Count == 0)
        {
            <MudText Color="Color.Warning">
                Cargando países...
            </MudText>
        }
        else
        {
            <MudSelect T="string"
                       Label="Países"
                       MultiSelection="true"
                       SelectedValues="_model.CountryCodes"
                       SelectedValuesChanged="@(values => _model.CountryCodes = values.ToHashSet())">

                @foreach (var country in _availableCountries)
                {
                    <MudSelectItem Value="@country.Code">
                        @country.Name
                    </MudSelectItem>
                }

            </MudSelect>
        }

    </DialogContent>

    <DialogActions>
        <MudButton Color="Color.Primary" OnClick="Submit">
            Guardar
        </MudButton>

        <MudButton Color = "Color.Secondary"
           OnClick="Close"> 
           Cerrar
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    public IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter]
    public Guid ProviderId { get; set; }

    private AddServiceRequest _model = new()
    {
        CountryCodes = new HashSet<string>()
    };

    private List<CountryDto> _availableCountries = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _availableCountries = await CountryApi.GetCountriesAsync();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine("Error cargando países:");
            Console.Error.WriteLine(ex.Message);

            _availableCountries = new List<CountryDto>();
        }
    }


    private async Task Submit()
    {
        try
        {
            // 1️⃣ Crear servicio
            var createdService =
                await ProviderApi.AddServiceAsync(ProviderId, new AddServiceRequest
                {
                    Name = _model.Name,
                    HourValueUsd = _model.HourValueUsd
                });

            // 2️⃣ Asignar países (solo si hay)
            if (_model.CountryCodes.Any())
            {
                await ProviderApi.AssignCountriesAsync(
                    ProviderId,
                    createdService.Id,
                _model.CountryCodes.ToList()
                );
            }

            // 3️⃣ Cerrar modal OK
            MudDialog.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine(ex);
        }
    }

    private void Close()
    {
        MudDialog.Cancel();
    }
}
