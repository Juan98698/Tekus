
@inject CountryApiService CountryApi
@inject ProviderApiService ProviderApi

@using Tekus.Frontend.Models
@using Tekus.Frontend.Services

<MudDialog>

    <DialogContent>
        <MudText Typo="Typo.h6">Nuevo servicio</MudText>

        <MudTextField Label="Nombre del servicio"
                      @bind-Value="_model.Name"
                      Required />

        <MudNumericField T="decimal"
                         Label="Valor hora (USD)"
                         @bind-Value="_model.HourValueUsd"
                         Required
                         Min="1" />

        <MudSelect T="string"
                   Label="Países"
                   MultiSelection
                   SelectedValues="_model.CountryCodes"
                   SelectedValuesChanged="v => _model.CountryCodes = v.ToHashSet()">

            @foreach (var country in _availableCountries)
            {
                <MudSelectItem Value="@country.Code">
                    @country.Name
                </MudSelectItem>
            }
        </MudSelect>
    </DialogContent>

    <DialogActions>
        <MudButton Color="Color.Primary" OnClick="Submit">
            Guardar
        </MudButton>

        <MudButton Color="Color.Secondary" OnClick="Cancel">
            Cerrar
        </MudButton>
    </DialogActions>

</MudDialog>
@code {
    [CascadingParameter]
    public IMudDialogInstance MudDialog { get; set; } = default!;
    private void Cancel()
    {
        Console.WriteLine($"Dialog instance: {MudDialog}");
        MudDialog?.Cancel();
    }
    [Parameter]
    public Guid ProviderId { get; set; }

    private AddServiceRequest _model = new();
    private List<CountryDto> _availableCountries = new();

    protected override async Task OnInitializedAsync()
    {
        _availableCountries = await CountryApi.GetCountriesAsync();
    }

    private async Task Submit()
    {
        var service = await ProviderApi.AddServiceAsync(
            ProviderId,
            new AddServiceRequest
            {
                Name = _model.Name,
                HourValueUsd = _model.HourValueUsd
            });

        if (_model.CountryCodes.Any())
        {
            await ProviderApi.AssignCountriesAsync(
                ProviderId,
                service.Id,
                _model.CountryCodes.ToList());
        }

        MudDialog.Close(DialogResult.Ok(true));
    }


}