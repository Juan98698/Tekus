@page "/summary"
@inject SummaryApiService Api
@using Tekus.Frontend.Services
@using Tekus.Frontend.Models.Summary;

<MudText Typo="Typo.h4">Resumen general</MudText>

<MudDivider Class="my-4" />

<MudGrid Class="mb-6">

    <MudItem xs="12" sm="6" md="3">
        <MudPaper Elevation="3" Class="pa-4 text-center">
            <MudText Typo="Typo.subtitle2">Países</MudText>
            <MudText Typo="Typo.h4" Color="Color.Primary">
                @_summary.ServicesByCountry.Count
            </MudText>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" sm="6" md="3">
        <MudPaper Elevation="3" Class="pa-4 text-center">
            <MudText Typo="Typo.subtitle2">Servicios</MudText>
            <MudText Typo="Typo.h4" Color="Color.Secondary">
                @_summary.ServicesByCountry.Sum(x => x.ServicesCount)
            </MudText>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" sm="6" md="3">
        <MudPaper Elevation="3" Class="pa-4 text-center">
            <MudText Typo="Typo.subtitle2">Proveedores</MudText>
            <MudText Typo="Typo.h4" Color="Color.Info">
                @_summary.ProvidersByCountry.Sum(x => x.ProvidersCount)
            </MudText>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" sm="6" md="3">
        <MudPaper Elevation="3" Class="pa-4 text-center">
            <MudText Typo="Typo.subtitle2">Top país (servicios)</MudText>

            @if (_summary.ServicesByCountry.Any())
            {
                var top = _summary.ServicesByCountry.First();

                <MudText Typo="Typo.body1">@top.CountryName</MudText>
                <MudText Typo="Typo.h5" Color="Color.Success">
                    @top.ServicesCount
                </MudText>
            }
        </MudPaper>
    </MudItem>

</MudGrid>

<MudGrid Class="mb-6">

    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4">
            <MudText Typo="Typo.h6">Top 3 países con mas servicios</MudText>

            <MudList T="CountryServicesSummaryDto" Dense="true">
                @foreach (var item in Top3Services)
                {
                    <MudListItem T="CountryServicesSummaryDto">
                        <MudText>@item.CountryName</MudText>
                        <MudSpacer />
                        <MudChip T="int" Color="Color.Success" Size="Size.Small">
                            @item.ServicesCount
                        </MudChip>
                    </MudListItem>
                }
            </MudList>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4">
            <MudText Typo="Typo.h6">Top 3 países con mas proveedores</MudText>

            <MudList T="CountryProvidersSummaryDto" Dense="true">
                @foreach (var item in Top3Providers)
                {
                    <MudListItem T="CountryProvidersSummaryDto">
                        <MudText>@item.CountryName</MudText>
                        <MudSpacer />
                        <MudChip T="int" Color="Color.Info" Size="Size.Small">
                            @item.ProvidersCount
                        </MudChip>
                    </MudListItem>
                }
            </MudList>
        </MudPaper>
    </MudItem>

</MudGrid>

<MudGrid>

    <!-- SERVICIOS POR PAÍS -->
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4">
            <MudText Typo="Typo.h6">Servicios por país</MudText>

            <MudTable Items="_summary.ServicesByCountry" Dense="true">
                <HeaderContent>
                    <MudTh>País</MudTh>
                    <MudTh>Cantidad</MudTh>
                </HeaderContent>

                <RowTemplate>
                    <MudTd>@context.CountryName</MudTd>
                    <MudTd>@context.ServicesCount</MudTd>
                </RowTemplate>
            </MudTable>
        </MudPaper>
    </MudItem>

    <!-- PROVEEDORES POR PAÍS -->
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4">
            <MudText Typo="Typo.h6">Proveedores por país</MudText>

            <MudTable Items="_summary.ProvidersByCountry" Dense="true">
                <HeaderContent>
                    <MudTh>País</MudTh>
                    <MudTh>Cantidad</MudTh>
                </HeaderContent>

                <RowTemplate>
                    <MudTd>@context.CountryName</MudTd>
                    <MudTd>@context.ProvidersCount</MudTd>
                </RowTemplate>
            </MudTable>
        </MudPaper>
    </MudItem>

</MudGrid>

@code {
    private SummaryResponse _summary = new();
    private IEnumerable<CountryServicesSummaryDto> Top3Services =>
        _summary.ServicesByCountry
            .OrderByDescending(x => x.ServicesCount)
            .Take(3);

    private IEnumerable<CountryProvidersSummaryDto> Top3Providers =>
        _summary.ProvidersByCountry
            .OrderByDescending(x => x.ProvidersCount)
            .Take(3);
    protected override async Task OnInitializedAsync()
    {
        _summary = await Api.GetSummaryAsync();
    }
    private int TotalCountriesWithServices =>
    _summary.ServicesByCountry.Count;

    private int TotalServices =>
        _summary.ServicesByCountry.Sum(x => x.ServicesCount);

    private int TotalProviders =>
        _summary.ProvidersByCountry.Sum(x => x.ProvidersCount);

    private CountryServicesSummaryDto TopServiceCountry =>
        _summary.ServicesByCountry
            .OrderByDescending(x => x.ServicesCount)
            .FirstOrDefault();

    private CountryProvidersSummaryDto TopProviderCountry =>
        _summary.ProvidersByCountry
            .OrderByDescending(x => x.ProvidersCount)
            .FirstOrDefault();
}