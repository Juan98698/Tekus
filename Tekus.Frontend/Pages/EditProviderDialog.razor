
@using Tekus.Frontend.Models
@using Tekus.Frontend.Services
@inject ProviderApiService Api

<MudDialog>

    <DialogContent>
        <MudText Typo="Typo.h6">Editar proveedor</MudText>

        <MudTextField Label="NIT" @bind-Value="_model.Nit" />
        <MudTextField Label="Nombre" @bind-Value="_model.Name" />
        <MudTextField Label="Email" @bind-Value="_model.Email" />

        <MudDivider Class="my-3" />

        @foreach (var field in _customFields)
        {
            <MudGrid>
                <MudItem xs="5">
                    <MudTextField Label="Campo"
                                  @bind-Value="field.Key" />
                </MudItem>

                <MudItem xs="5">
                    <MudTextField Label="Valor"
                                  @bind-Value="field.Value" />
                </MudItem>

                <MudItem xs="2">
                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                   OnClick="@(() => RemoveField(field))" />
                </MudItem>
            </MudGrid>
        }

        <MudButton Variant="Variant.Outlined"
                   OnClick="AddField">
            Agregar campo
        </MudButton>
    </DialogContent>

    <DialogActions>
        <MudButton Color="Color.Primary" OnClick="Save">
            Guardar
        </MudButton>

        <MudButton Color="Color.Secondary" OnClick="Cancel">
            Cancelar
        </MudButton>
    </DialogActions>

</MudDialog>

@code {
    [CascadingParameter]
    public IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter]
    public ProviderDto Provider { get; set; } = default!;

    private UpdateProviderRequest _model = new();
    private List<CustomFieldDto> _customFields = new();

    protected override void OnInitialized()
    {
        _model.Id = Provider.Id;
        _model.Nit = Provider.Nit;
        _model.Name = Provider.Name;
        _model.Email = Provider.Email;

        _customFields = Provider.CustomFields
            .Select(kv => new CustomFieldDto
            {
                Key = kv.Key,
                Value = kv.Value
            })
            .ToList();
    }

    private void AddField()
    {
        _customFields.Add(new CustomFieldDto());
    }

    private void RemoveField(CustomFieldDto field)
    {
        _customFields.Remove(field);
    }

    private async Task Save()
    {
        _model.CustomFields = _customFields
            .Where(f => !string.IsNullOrWhiteSpace(f.Key))
            .ToDictionary(f => f.Key, f => f.Value);

        await Api.UpdateProviderAsync(_model);

        MudDialog.Close(DialogResult.Ok(true));
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}