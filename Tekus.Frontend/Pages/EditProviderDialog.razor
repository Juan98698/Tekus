
@using Tekus.Frontend.Models
@using Tekus.Frontend.Services
@inject ProviderApiService Api
@inject ISnackbar Snackbar

<MudDialog>

    <DialogContent>
        

        <MudForm @ref="_form" Model="_model">

            <MudTextField Label="NIT"
                          @bind-Value="_model.Nit"
                          Required="true"
                          RequiredError="El NIT es obligatorio" />

            <MudTextField Label="Nombre"
                          @bind-Value="_model.Name"
                          Required="true"
                          RequiredError="El nombre es obligatorio" />

            <MudTextField Label="Email"
                          @bind-Value="_model.Email"
                          Required="true"
                          RequiredError="El email es obligatorio"
                          Validation="@( (string e) =>
                                    string.IsNullOrWhiteSpace(e) || !e.Contains("@")
                                        ? "Email inválido"
                                        : null)" />

            <MudDivider Class="my-3" />

            <MudText Typo="Typo.subtitle1">Campos personalizados</MudText>

            @foreach (var field in _customFields)
            {
                <MudGrid Class="mb-2">
                    <MudItem xs="5">
                        <MudTextField Label="Campo"
                                      @bind-Value="field.Key" />
                    </MudItem>

                    <MudItem xs="5">
                        <MudTextField Label="Valor"
                                      @bind-Value="field.Value" />
                    </MudItem>

                    <MudItem xs="2" Class="d-flex align-center">
                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                       Color="Color.Error"
                                       OnClick="@(() => RemoveField(field))" />
                    </MudItem>
                </MudGrid>
            }

            <MudButton Variant="Variant.Outlined"
                       StartIcon="@Icons.Material.Filled.Add"
                       OnClick="AddField">
                Agregar campo
            </MudButton>

        </MudForm>
    </DialogContent>

    <DialogActions>
        <MudButton Color="Color.Primary"
                   Disabled="_isSubmitting"
                   OnClick="Save">
            @(_isSubmitting ? "Guardando..." : "Guardar")
        </MudButton>

        <MudButton Color="Color.Secondary" OnClick="Cancel">
            Cancelar
        </MudButton>
    </DialogActions>

</MudDialog>

@code {
    [CascadingParameter]
    public IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter]
    public ProviderDto Provider { get; set; } = default!;

    private MudForm _form = default!;
    private UpdateProviderRequest _model = new();
    private List<CustomFieldDto> _customFields = new();

    protected override void OnInitialized()
    {
        _model.Id = Provider.Id;
        _model.Nit = Provider.Nit;
        _model.Name = Provider.Name;
        _model.Email = Provider.Email;

        _customFields = Provider.CustomFields
            .Select(kv => new CustomFieldDto
            {
                Key = kv.Key,
                Value = kv.Value
            })
            .ToList();
    }

    private void AddField()
    {
        _customFields.Add(new CustomFieldDto());
    }

    private void RemoveField(CustomFieldDto field)
    {
        _customFields.Remove(field);
    }
    private bool _isSubmitting = false;
    private async Task Save()
    {
        await _form.Validate();
        if (!_form.IsValid)
            return;

        _isSubmitting = true;

        try
        {
            _model.CustomFields.Clear();

            foreach (var field in _customFields)
            {
                if (!string.IsNullOrWhiteSpace(field.Key))
                    _model.CustomFields[field.Key] = field.Value;
            }

            await Api.UpdateProviderAsync(_model);

            Snackbar.Add("Proveedor Actualizado correctamente", Severity.Success);
            MudDialog.Close(DialogResult.Ok(true));
        }
        catch (HttpRequestException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}